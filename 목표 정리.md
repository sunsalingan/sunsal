# 목표 정리 (Target Summary)

> [!IMPORTANT]
> **이 문서는 프로젝트의 절대적인 기준(Source of Truth)입니다.**
> 모든 작업은 이 문서에 정의된 목표와 흐름을 기반으로 진행되어야 하며, 작업 시작 전 반드시 이 문서를 최우선으로 확인해야 합니다.
>
> **[필수 검증 수칙]**
> 모든 작업은 브라우저에서 **여러 번 반복 테스트**하여 오류가 없음을 확실히 확인해야 합니다.
> 디버깅은 정상적으로 작동할 때까지 지속해야 하며, 구현 완료 시 **반드시 구동 확인을 위한 링크(URL)를 제공**해야 합니다.
> **[배포 수칙]**
> 코드를 수정했을 경우, 로컬 테스트에 그치지 말고 **반드시 재배포(`firebase deploy`)를 수행**하여 실제 서버 반영 여부를 확인해야 합니다.
> **[문서 작성 수칙]**
> Walkthrough, Implementation Plan 등 모든 산출물 문서는 **반드시 한글로 작성**해야 합니다.

## 1. 긴급 검토 및 조치 사항 (Immediate Actions)
현재 가장 우선순위가 높은 작업 및 검토가 필요한 항목입니다.

### [완료] 관리자 페이지 (Admin Page) 구축
- **목표**: 데이터 안정성을 위한 백업(Export) 및 복구(Import) 기능 구현.
- **주요 기능**:
    - **백업**: `users`, `reviews` 컬렉션 전체 데이터를 JSON 파일로 다운로드.
    - **복구**: JSON 업로드 시 기존 데이터를 **모두 삭제(초기화)**한 후 업로드된 데이터로 덮어쓰기.
    - **경로**: `/admin` (비밀번호 `0901` 보호 적용 완료).

### [완료] 점수 자동 산정 로직 교체
- **상태**: 구현 및 배포 완료 (v2.0).
- **내용**: 랭킹(Rank Index) 기반 정규분포 + 가중치(User Weight) + 베이지안 평균 적용.
- **검증**: 시더(Seeder) 및 어드민 도구를 통한 검증 데이터 테스트 완료.

---

## 2. 프로젝트 핵심 및 흐름 (Project Core & Flow)

### 2.1 핵심 컨셉 (Core Concept)
**"별점은 주관적이다. 하지만 순위는 절대적이다."**
사용자는 절대적인 점수(별점) 대신, 자신이 방문한 식당들 간의 관계(Ranking)를 정의합니다. 시스템은 이 순위를 분석하여 수학적(정규분포)으로 공정한 점수를 부여합니다.

### 2.2 주요 기능 (Key Features)

### [필수 구현 목표]
#### A. 랭킹 기반 리뷰 시스템
*   **핵심 로직**: 사용자가 직접 점수(0~10)를 입력하지 않음. 대신 기존 맛집 리스트 사이에 "끼워넣기(Ranking)"하면, 전체 리스트의 백분위(Percentile)를 기준으로 점수가 자동 산출됨.
*   **구현 계획 요약 (Implementation Plan)**:
    1.  **2단계 랭킹 UI (Pivot Ladder)**:
        *   **Step 1 (구간 선택)**: 리뷰가 10개 이상일 경우, 전체를 5~10개 단위로 그룹핑하여(예: 1위~10위, 11위~20위) 대략적인 위치를 먼저 선택.
        *   **Step 2 (상세 순위)**: 선택된 구간 내에서 드래그 앤 드롭 또는 버튼 클릭으로 정확한 순위 지정.
    2.  **점수 산정 알고리즘**:
        *   `Rank Index` (순위) 저장 -> `Percentile` 계산 -> `Score` (10.0 만점) 환산.
        *   1등은 항상 10.0점 유지, 꼴등은 점수가 낮아지지만 8.0점(보정값) 이상 유지 등 미세 조정.
    3.  **연쇄 업데이트 (Ripple Effect)**:
        *   새 리뷰 추가 시, 기존 랭킹에 있던 식당들의 순위가 밀리며 점수가 연쇄적으로 재계산됨. (Batch Update 필수)
*   **랭킹 모순 방지 (Bounded Ranking Logic)**:
    *   **1단계 (카테고리 랭킹)**: 같은 카테고리 내에서 순위 결정 (예: A식당 < 내 식당 < B식당).
    *   **2단계 (전체 랭킹)**: 1단계에서 결정한 상대적 위치를 기반으로 **전체 랭킹의 선택 범위를 제한**.
    *   **예시**: A식당(전체 10위)과 B식당(전체 25위) 사이를 선택했다면, 전체 랭킹 선택 시 **11위 ~ 24위 구간만 노출**.
    *   **목적**: 카테고리 랭킹과 전체 랭킹 간의 논리적 모순 방지.
*   **카테고리 단순화 (Category Normalization)**:
    *   네이버 지도 카테고리를 아래 5대 분류로 통합 관리하여 랭킹 파편화 방지.
    
    | 대분류 (Big Category) | 포함 키워드 (Keywords) |
    | :--- | :--- |
    | **한식** | 한식, 국밥, 찌개, 전골, 삼겹살, 갈비, 족발, 분식, 백반, 국수 등 |
    | **일식** | 일식, 스시, 초밥, 돈가스, 라멘, 우동, 이자카야, 텐동, 소바 등 |
    | **중식** | 중식, 짜장, 짬뽕, 탕수육, 마라, 양꼬치, 딤섬 등 |
    | **아시안** | 아시안, 태국, 베트남, 인도, 쌀국수, 팟타이, 커리 등 |
    | **양식** (치킨/피자 포함) | 양식, 파스타, **피자**, 스테이크, 버거, 이탈리안, **치킨**, 브런치 등 |
    | **카페** | 카페, 커피, 디저트, 베이커리, 빵, 케이크, 빙수 등 |
    | **기타** | 술집, 편의점 등 위 키워드 미포함 시 |

*   **기대 효과**: 정량적 점수 고민 없이 "얘보다 맛있다/맛없다"만 판단하면 되므로 리뷰 작성 부담 감소 및 직관적 랭킹 완성.
    -   **Step 1: 검색 및 인증**:
        -   식당 검색 후 **위치 및 영수증 인증** 필수 (트롤링 방지).
        -   "먹고 난 직후"의 리뷰 정확성을 강조.
    -   **Step 2: 한줄평 작성**:
        -   **30자 글자수 제한**. 깔끔하고 직관적인 리뷰 지향.
    -   **Step 3: 계층적 랭킹 선택 (Representative Ladder)**:
        -   **[설정 가능]** 사용자가 설정(Settings)에서 **그룹핑 단위(Ranking Interval)**를 변경 가능 (기본 5개, 10개, 20개 등).
        -   리뷰가 많아질 경우, 5개 단위는 너무 길어질 수 있으므로 단위를 넓혀서(예: 10개, 20개) 쾌적하게 구간을 선택하도록 지원.
        -   **대표 기준점(Anchor)**: 설정된 단위(N)에 따라 1위, (1+N)위, (1+2N)위... 식당만 노출.
        -   **구간 선택**: "A식당(1위)과 B식당(1+N위) 사이" 버튼 클릭.
    -   **Step 4: 상세 위치 확정**:
        -   선택된 구간 내(N개 식당)에서 상세 순위 결정.
    4.  **점수 자동 산정**:
        -   **[제1원칙]** 식당의 점수는 **사용자가 직접 지정할 수 없음**.
        -   **[제2원칙]** 점수는 오직 **식당의 순위(Ranking)**에 의해서만 결정됨.
        -   **[제3원칙]** 랭킹 확정 시 정규분포(Normal Distribution)를 기준으로 **최고 10.0점 ~ 최하 1.0점** 자동 부여.
        -   (1위 = 10.0점, 최하위 = 1.0점, 중간 = 정규분포 곡선)
        -   **[제4원칙] (가중치 적용)**: 식당의 최종 평균 점수 계산 시, **리뷰를 많이 작성한 유저(활동성 높은 유저)의 점수에 가중치**를 부여.
            -   공식: `Weight = 1 + log10(Total Review Count)`
            -   목적: 리뷰 1개인 유저의 10점과 리뷰 1000개인 유저의 10점을 차등 대우하여 신뢰도 확보.

#### B. 뷰 모드 (View Modes)
-   **전체 (Global)**: 모든 사용자의 데이터를 집계한 평균 평점 랭킹.
-   **나의 지도 (My Map)**: 내가 등록한 식당과 나의 랭킹.
-   **친구 (Friends)**: 팔로우한 유저들의 맛집 지도.
-   **프랜차이즈 (Franchise)**: 특정 브랜드의 지점별 전국 순위 비교 (별도 메뉴 탭).

#### C. 소셜 및 데이터 (Social & Data)
-   **취향 일치도 (Match Rate)**: 공통 리뷰한 식당의 랭킹 유사도를 분석하여 %로 표시.
-   **예상 점수 (Predicted Score)**: 내가 아직 리뷰하지 않은 식당을 선택했을 때, 내 취향과 비슷한 유저들의 평가를 기반으로 **나의 예상 만족도(점수)를 예측**하여 제공.
-   **데이터 관리**: Firebase Firestore 사용. 관리자 페이지를 통한 백업/복구.

### 2.3 부가 기능 및 확장 (Additional Features)
현재 구현되거나 예정된 핵심 외 부가 기능 목록입니다.

#### A. 관리자 페이지 (Admin & Management)
-   **데이터 관리**: 전체 데이터 백업(Export) 및 복구(Import).
-   **리뷰 관리**: 전체 사용자의 리뷰 조회 및 **악성 리뷰 삭제/관리** 기능.

#### B. 기타 예정 기능
-   **소셜 로그인**: 구글, 카카오 등 간편 로그인.
-   **초대 및 공유**: 친구 초대 링크 생성.

### 2.3 시스템 플로우 (System Flowchart)

**리뷰 등록 및 점수 계산**
```mermaid
graph TD
    A[사용자 리뷰 등록] --> B[식당 검색/인증]
    B --> C[랭킹 위치 결정 (User Input)]
    C --> D[Rank Index 저장]
    D --> E{Score Calculator}
    E --> F[해당 유저의 모든 리뷰 조회]
    F --> G[Rank Index 기반 정규분포 점수 재계산 (1.0~10.0)]
    G --> H[Firestore Batch Update]
```

---

## 3. 구현 로드맵 (Implementation Roadmap)

### Phase 1: 핵심 로직 정비 (Current)
- [x] 점수 산정 알고리즘 (Normal Distribution) 구현.
- [x] 배치 업데이트(Batch Update) 로직 적용.
- [x] `firebase.js` 등 기초 모듈 안정화.

### Phase 2: 관리 기능 (Completed)
- [x] Admin Page UI ([src/pages/AdminPage.jsx](file:///c:/Users/hmcho/Desktop/sunsal/src/pages/AdminPage.jsx)).
- [x] JSON Export (Backup) 기능.
- [x] JSON Import & Restore (Dangerous Reset) 기능.

### Phase 3: 완성도 향상 (Future)
- [ ] UI/UX 폴리싱 (Dark Mode, Mobile Response).
- [x] **친구 시스템 고도화**: 검색, 팔로우, 피드(진행중).
- [ ] 성능 최적화 (Redis 캐싱 등 도입 검토).

---

## 4. 랭킹 로직 고도화 (Ranking Logic v2.0)

기존의 단순 평균/랭킹 방식이 신규 식당(리뷰 소수)이 상위권에 고정되는 "평균의 함정"과 "트롤링"에 취약하다는 점을 보완하기 위해, **3가지 뷰(View)에 따라 차별화된 점수 산정 로직**을 적용합니다.

### 4.1 뷰 모드별 적용 전략

| 뷰 모드 | 적용 로직 (Intensity) | 설명 |
| :--- | :--- | :--- |
| **나의 랭킹** (My Ranking) | **기존 유지 (Raw)** | 내가 정한 순위 그대로 점수 변환 (Percentile → Normal Dist). 외부 개입 없이 내 주관이 100% 반영됨. |
| **전체 랭킹** (Global Ranking) | **최상 (Strongest)** | 모든 보정 로직(가중치, 베이지안, 진입장벽)을 가장 강력하게 적용하여 객관성과 신뢰도 확보. |
| **친구 랭킹** (Friend Ranking) | **가변 (Dynamic)** | 친구 수(N)에 따라 보정 강도 조절.<br>- 친구가 많음(Data 충분) → Global에 가깝게 보정.<br>- 친구가 적음(Data 부족) → 보정 약하게(Raw에 가깝게). |

### 4.2 세부 알고리즘 (Detailed Algorithms)

#### A. 사용자 신뢰도 가중치 (User Reliability Weight)
리뷰 작성자의 활동량(누적 리뷰 수)에 따라 해당 리뷰가 식당 점수에 미치는 영향력을 제한합니다.
- **입문자** (0~2개): 가중치 **0.3** (점수의 30%만 반영)
- **일반** (3~9개): 가중치 **0.7**
- **전문가** (10개+): 가중치 **1.0** (100% 반영)

#### B. 베이지안 평균 (Bayesian Average)
데이터(리뷰)가 적을 때 극단적인 값(10점/1점)이 되는 것을 방지하고, 전체 평균(5.0)으로 수렴하게 만듭니다.
> **Formula**: `( (R * v) + (C * m) ) / (v + m)`
- `R`: 해당 식당의 현재 단순 평균 평점
- `v`: 해당 식당의 리뷰 개수 (Volume)
- `m`: 가중치를 주기 위한 최소 리뷰 수 (**기본값 5**)
- `C`: 전체 식당들의 평균 평점 (**기본값 5.0**)

#### C. 랭킹 진입 장벽 (Threshold)
- **조건**: 리뷰가 **3개 미만**인 식당은 **'전체 랭킹(Global Ranking)' 리스트에서 아예 제외** (노출되지 않음).
